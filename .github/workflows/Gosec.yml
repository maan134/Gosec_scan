name: Gosec SARIF Scan

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
permissions:
  contents: read
  checks: write
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on
    steps:
      - name: Checkout Source
        uses: actions/checkout@v3

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          # use Trivy official install script for simplicity
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          
      - name: Run Gosec Security Scanner
        uses: securego/gosec@v2.18.2
        with:
          # we let the report trigger content trigger a failure using the GitHub Security features.
          args: '-no-fail -fmt sarif -out results.sarif ./...'
          
      - name: Run Trivy filesystem scan (SARIF)
        run: |
          # trivy fs scans the workspace; output SARIF file
          trivy fs --format sarif --output trivy-results.sarif .
          echo "Trivy SARIF written to trivy-results.sarif"
          continue-on-error: true
          
            
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          # Path to SARIF file relative to the root of the repository
          sarif_file: results.sarif
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: GoSec report
          path: |
            results.sarif
            trivy-results.sarif
